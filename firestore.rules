// Firestore security rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // USER DOCUMENTS
    match /users/{uid} {

      // allow read if logged in
      allow read: if request.auth != null;

      // allow create only if writing to own doc
      allow create: if request.auth != null
                    && request.auth.uid == uid;

      // prevent modifying "role"
      allow update: if request.auth != null
                    && request.auth.uid == uid
                    && request.resource.data.role == resource.data.role;

      // delete not allowed
      allow delete: if false;
    }

    // MEALS (seller only)
    match /meals/{mealId} {
      allow read: if true;

      allow create, update: if request.auth != null
                            && request.resource.data.sellerId == request.auth.uid;

      allow delete: if request.auth != null
                    && resource.data.sellerId == request.auth.uid;
    }

    // ORDERS
    match /orders/{orderId} {
      allow read, update: if request.auth != null
                          && (
                               request.auth.uid == resource.data.buyerId ||
                               request.auth.uid == resource.data.sellerId
                             );

      allow create: if request.auth != null;

      allow delete: if false;
    }
  }
}
